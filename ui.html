<!DOCTYPE html>
<html>
<head>
  <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAMAAABlApw1AAAAmVBMVEXu2zH////07pXy5V7x5FP69s3x5E/58bb69sr48KX585P69sf27IO7iADfxCBsSwCsz7mCXwD58rz+/fjBkgBiRAB6sCa2ggCarFK71sWRpUKFYgB2VAB4VgCQbgCDYABqSQBlRgBxTwCxfQCuj02dawCjdzKBpjqdsGKKqEB9WQB+oTGLeAKwz7vy5mvM3sXi7NiozrXJ2cFosBb4AAAE/ElEQVR4Ae3abW+bSBQF4MMuYDZZ7Y7xXFhgbMAGmwax+/9/3AV6MXGyqVQpd0S+R/mCHM4biDcEQRAEQRAEQRAEQRAEQRAEQRAEQfAn4rXV6wD8CuBPtQoYA67U1Qs/Ue/0AugnILr9BAA9B6S1xkvxDkTXNZYDfQNqXmEpNtDTR7MiwfXMCrzPJy2BHgPxEtdFqQ92OjxXoHVNm2vFHUw0wQU5EHPc3DPNp59gbGHEdPY13GxNL3iF2wTuGf46WKXX/DvCL3mLn2roVN2FY9zmx3r64mJwhZPUuM0UitSvDpUOhz2OmY9xozbP1FRHcw3sNY6YfFyl0XPaUFxg4xrj9i5e70jRH4DkI0ZDaqnRjFe1fgbsUkYNnT6Nw1G5AY5O8bVoPL0bXqgL1OFTVvFtMeRdtdP46Y9Vqc6BLW3wnRnxOXLCCTVxMQP2sEJEBY62k1t8M5LKOzaLfwJ7oqiJ9P7I1Dgu+OEXnAeF8wMYu3WC0wQf3k5UQCm4Mc7DPRMVFkNn3tMcJzE9eGjXOVCw9XAWK/GNfyf0Hue0+MyPkgpnso6BdxVOI2eDqFfW81LlYKEk29tHnC25YgN0D70uoQrCLYLaF+f9Ytt1P6tFvlvU0dS+D7SWmYYK0bRY7X74nEX5Q1yvsj70S5+1wj7CUuxQRyZvnEfzL7vxwL8fSrYDWkOxHaKtYa6BIgv/1rZaT/afDhJf9H5f5VEPAFZqL1tPZ9Hcm4CZnrbTaD9r3gNqFJ+iyOGqP8SBMoNfJbY/NrIf1Kv+sKP4X+DKgUAWNr8vYHqG61+A9hn7Aof3E/z2CZjlUXsFtClvPUDr5ZG38C83A9pEjz6F+/fPvxc/HBQI9MHWI2BrpfaAhYfZJgK23rJF9AtKvQBU6R08i1gBaK2kAhYJNloiKi2cTDLTdoAq05bQaSNl2wNqXNQATJbUekE6B1QKKUAJaVFXbwvIRhUwFaVR1wLKsRbAZOVajcBx1GYRsDm5WAvAHi0V0BLCRk4xWVZAluQsA4KKDJBFucSQ8UySJsYC0NqY9bCJKKvRoLZNkQF0FpUWkCl5ZIpHtKbr0RpQKlIZ0lsZJVMNqLSQLXa6vwXmFNWKsR7QScFKG0Bn+h4fCOOVitZ2XDFa9lWKxQQPwZ66WNr9eCtjRNR1sVt4gq5sI3MDCL6LkuVNI/gBQm81UgTY0kOx6lUW6z2gSpV2QKXM6rWbjjMKPB2+8XXvaXPbVJVDd9EAxS5BmwxIsRhwbCBNl6Nt7Vb9wIAwU7/ZtUYfBFe+KZBYmY7E/kKLZAGouHHvNtl26wHQq0lZTBUQn97fPD10iS5k0wOBn/dHRyeBnv4lofhV30uFqRt6ZbvdJJ40kGaRBnSkkkbmvEkCJOw4a0TLn6W9OLxtOx0BWvWJjnQIzPE5MUAvXOv3qfZwGgdE05qeAvZz/DfOFw3/P8EKv/PU84Hc/jR+E97Z5x8PgXH3TdnjexyxpdFNW8D1X8Y2Yppt0gA1PTbD/7GjaQPU1dLfNJ+9neMX/cDcHbDgT+EL5pnb0V8D3yN/2XwmX5pvAf1y6DUyBEEQBEEQBEEQBEEQBEEQBEEQ/AUgPqZ5mOB/uwAAAABJRU5ErkJggg==">
  <style>
    :root {
      --color-primary: #F9F9F9;
      --color-secondary: #625A59;
      --color-tertiary: #787878;
      --color-text: #333333;
      --color-hint: #929292;
      --color-border: #444444;
      --color-accent: #DE710C;
      --color-button: #DE710C;
      --color-button-hover: #c76407;
      --color-background: #292929;
      --color-input-bg: #1E1E1E;
      --color-error: #DC2626;
      --border-radius: 6px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      color: var(--color-text);
      background-color: var(--color-background);
      font-size: 14px;
      line-height: 1.5;
    }

    ::placeholder {
      color: var(--color-tertiary)
    }
    
    h1 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: var(--spacing-md);
      color: var(--color-primary);
    }
    
    .form-group {
      margin-bottom: var(--spacing-md);
    }
    
    label {
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
      font-size: 13px;
      color: var(--color-primary);
    }
    
    input, textarea, select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      font-size: 14px;
      font-family: inherit;
      background-color: var(--color-input-bg);
      transition: border-color 0.2s ease;
      color: var(--color-primary);
    }

    select.minimal {
      margin: 0;      
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;

      background-image:
        linear-gradient(45deg, transparent 50%, gray 50%),
        linear-gradient(135deg, gray 50%, transparent 50%),
        linear-gradient(to right, #1e1e1e, #1e1e1e);
      background-position:
        calc(100% - 20px) calc(1em + 2px),
        calc(100% - 15px) calc(1em + 2px),
        calc(100% - 2.5em) 0.5em;
      background-size:
        5px 5px,
        5px 5px,
        1px 1.5em;
      background-repeat: no-repeat;
    }

    select {
      color: var(--color-primary)
    }
    option:not(:first-of-type) {
      color: black;
    }
    /* the modification */
    option:first-of-type {
      display: none;
    }

    select:-moz-focusring {
      color: transparent;
      text-shadow: 0 0 0 #000;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--color-button);
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    button {
      background: var(--color-button);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      padding: 10px 20px;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      margin-top: var(--spacing-md);
      transition: background-color 0.2s ease;
    }

    .button--secondary {
      background: #444444 !important;
      &:hover {
       background: #535353;
      }
    }
    
    button:hover {
      background: var(--color-button-hover);
    }
    
    .required::after {
      content: " *";
      color: var(--color-error);
    }
    
    .optional {
      color: var(--color-hint) !important;
      font-weight: normal;
      font-size: 12px;
      margin-left: 4px;
    }
    
    .image-preview {
      max-width: 100%;
      max-height: 150px;
      margin-top: var(--spacing-sm);
      display: none;
      border-radius: var(--border-radius);
      object-fit: cover;
    }
    
    .file-input-container {
      position: relative;
      margin-top: var(--spacing-sm);
      width: 100%;
      height: 120px;
      cursor: pointer;
      background: var(--color-background);
      border-radius: var(--border-radius);
      border: 1px dashed var(--color-secondary);
      overflow: hidden;
    }
    
    .file-input-label {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      text-align: center;
      position: absolute;
      top: 0;
      left: 0;
    }

    #uploadImageBtn {
        background-color: var(--color-button);
        color: white;
        border: none;
        border-radius: var(--border-radius);
        padding: 8px 16px;
        font-weight: 500;
        font-size: 13px;
        cursor: pointer;
        margin-bottom: var(--spacing-sm);
        width: auto;
        margin-top: 0;
    }

    #uploadImageBtn:hover {
        background-color: var(--color-button-hover);
    }

    .file-input-container:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    #imageFile {
      opacity: 0;
      width: 1px;
      height: 1px;
      position: absolute;
      top: -10px;
      left: -10px;
      z-index: -1;
      pointer-events: none;
    }
    
    .file-name {
      font-size: 12px;
      margin-top: 6px;
      color: var(--color-secondary);
    }
    
    .success-message {
      background-color: #F0FCF2;
      color: #157B40;
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      margin-bottom: var(--spacing-md);
      display: none;
    }
    
    .error-message {
      background-color: #FEE2E2;
      color: var(--color-error);
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      margin-bottom: var(--spacing-md);
      display: none;
    }
    
    /* Estilos para os tipos de mudança */
    .change-type-item {
      padding: 4px 8px;
      margin-right: 4px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: bold;
      text-transform: uppercase;
    }
    
    .badge-new-feature {
      background: #F0FCF2;
      color: #157B40;
    }
    
    .badge-update {
      background: #EEF6FF;
      color: #107ABF;
    }
    
    .badge-bug-fix {
      background: #FFF7E8;
      color: #CC871F;
    }
    
    .badge-removed {
      background: #FEE2E2;
      color: #DC2626;
    }
    
    .badge-refactoring {
      background: #F4F0FF;
      color: #754CD6;
    }
    
    .badge-improvement {
      background: #E8F8FC;
      color: #2693BA;
    }
    
    .badge-deprecation {
      background: #FFE6F0;
      color: #BF305E;
    }
    
    .badge-layout-adjustment {
      background: #F0F0F0;
      color: #666666;
    }
    
    .image-size-hint {
      color: var(--color-hint);
      font-size: 12px;
      margin-bottom: 8px;
      font-style: italic;
    }
    
    /* Estilos para navegação entre páginas */
    .page {
        display: none;
    }
    
    .page.active {
        display: block;
    }
    
    .page-selector {
        width: 100%;
        padding: 16px;
        background-color: var(--color-background);
        /* border-bottom: 1px solid var(--color-border); */
    }
    
    .page-selector select {
        width: 100%;
        height: 40px;
        padding: 8px 12px;
        border: 1px solid var(--color-border);
        border-radius: 4px;
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        color: var(--color-primary);
        background-color: var(--color-input-bg);
        background-image:
          linear-gradient(45deg, transparent 50%, var(--color-tertiary) 50%),
          linear-gradient(135deg, var(--color-tertiary) 50%, transparent 50%);
        background-position:
          calc(100% - 20px) calc(1em + 2px),
          calc(100% - 15px) calc(1em + 2px);
        background-size:
          5px 5px,
          5px 5px;
        background-repeat: no-repeat;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }
    
    .page-info {
        margin-top: 16px;
        padding: 16px;
        text-align: center;
    }
    
    .page-info h3 {
        font-family: 'Inter', sans-serif;
        font-size: 16px;
        font-weight: 600;
        color: var(--color-primary);
        margin-bottom: 8px;
    }
    
    .page-info p {
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        color: var(--color-secondary);
        margin-bottom: 16px;
    }
    
    .button-container {
        display: flex;
        gap: 8px;
        justify-content: center;
    }
    
    .button-container button {
        min-width: 120px;
    }
    
    /* Estilo para estado de carregamento */
    .loading {
        position: relative;
        pointer-events: none;
    }
    
    .loading::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.2);
        border-radius: var(--border-radius);
        backdrop-filter: blur(2px);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid var(--color-button);
        border-radius: 50%;
        border-top-color: transparent;
        margin: 20px auto;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Página inicial com seletor de páginas -->
  <div id="home-page" class="page active">
    <div class="page-selector">
      <label>Selecione uma página do projeto</label>
      <select id="page-select">
        <option value="" disabled selected>Nenhuma página selecionada</option>
      </select>
    </div>
    <div class="page-info" id="changelog-status" style="display: none;">
      <h3>Changelog encontrado!</h3>
      <p class="optional">Esta página já possui um changelog com <span id="entry-count">0</span> registro(s).</p>
      <div class="button-container">
        <button class="button button--secondary" onclick="navigateToChangelog()">Ver Changelog</button>
        <button class="button button--primary" onclick="navigateToChangelogForm('add')">Adicionar Registro</button>
      </div>
    </div>
    <div class="page-info" id="no-changelog" style="display: none;">
      <h3>Nenhum changelog encontrado</h3>
      <p class="optional">Esta página ainda não possui um changelog. Deseja criar um agora?</p>
      <div class="button-container">
        <button class="button button--primary" onclick="navigateToChangelogForm('create')">Criar Changelog</button>
      </div>
    </div>
  </div>

  <!-- Página do formulário unificado de changelog -->
  <div id="changelog-form-page" class="page">
    <h1 id="form-title">Gerenciar Changelog</h1>
    
    <div id="successMessage" class="success-message">
      Operação realizada com sucesso!
    </div>
    
    <div id="errorMessage" class="error-message">
      Erro ao processar a solicitação. Tente novamente.
    </div>
    
    <form id="changelogForm">
      <div class="form-group">
        <label class="required" for="changeType">Classifique sua alteração</label>
        <select id="changeType" class="minimal" name="changeType">
          <option value="">Selecione o tipo da alteração</option>
          <option value="New Feature">Nova Feature</option>
          <option value="Update">Update</option>
          <option value="Bug Fix">Bug Fix</option>
          <option value="Removed">Removido</option>
          <option value="Refactoring">Refatoração</option>
          <option value="Improvement">Melhoria</option>
          <option value="Deprecation">Depreciação</option>
          <option value="Layout Adjustment">Ajuste de Layout</option>
        </select>
      </div>

      <div class="form-group">
        <label class="required" for="title">Título</label>
        <input type="text" id="title" name="title" placeholder="Informe um título descritivo para alteração">
      </div>
      
      <div class="form-group">
        <label class="required" for="description">Descrição</label>
        <textarea id="description" name="description" placeholder="Descreva em detalhes o que foi alterado"></textarea>
      </div>
      
      <div class="form-group">
        <label for="linkLabel">Label do link <span class="optional">(opcional)</span></label>
        <input type="text" id="linkLabel" name="linkLabel" placeholder="Texto do link (ex: Protótipo)">
      </div>

      <div class="form-group">
        <label for="linkUrl">Endereço do link <span class="optional">(opcional)</span></label>
        <input type="text" id="linkUrl" name="linkUrl" placeholder="http:// ou https://">
      </div>
      
      <div class="form-group">
        <label for="imageFile">Imagem <span class="optional">(opcional)</span></label>
        <div class="file-input-container" id="fileInputContainer">
          <label class="file-input-label" for="imageFile">
            <button class="button button--secondary" type="button" id="uploadImageBtn">Enviar Imagem</button>
            <div class="image-size-hint">Tamanho recomendado de 600px × 330px</div>
          </label>
          <input type="file" id="imageFile" accept="image/*">
          <div class="file-name" id="fileName"></div>
        </div>
        <img id="imagePreview" class="image-preview">
        <button type="button" id="removeImageBtn" style="display: none; margin-top: 10px; background-color: #DC2626; width: auto; padding: 8px 16px;">Remover imagem</button>
      </div>
      
      <div class="button-container" style="margin-top: 20px;">
        <button type="button" id="cancelBtn" onclick="navigateToPage('home-page')" style="background-color: #444444;">Cancelar</button>
        <button type="submit" id="submitBtn">Adicionar</button>
      </div>
    </form>
  </div>

  <script>
    // Estado global do plugin
    const pluginState = {
        selectedPage: null,
        hasChangelog: false,
        entryCount: 0,
        formMode: 'create' // 'create' para criar novo changelog, 'add' para adicionar entrada
    };

    // Função para mostrar mensagem de erro
    function showError(message) {
        console.error('Erro:', message);
        
        // Criar elemento de erro
        const errorElement = document.createElement('div');
        errorElement.className = 'error-message';
        errorElement.style.display = 'block';
        errorElement.style.position = 'fixed';
        errorElement.style.top = '10px';
        errorElement.style.left = '50%';
        errorElement.style.transform = 'translateX(-50%)';
        errorElement.style.zIndex = '1000';
        errorElement.style.width = '90%';
        errorElement.style.maxWidth = '400px';
        errorElement.style.padding = '12px';
        errorElement.style.borderRadius = '4px';
        errorElement.style.background = '#FEE2E2';
        errorElement.style.color = '#DC2626';
        errorElement.style.fontSize = '14px';
        errorElement.style.textAlign = 'center';
        errorElement.textContent = message;
        
        // Adicionar ao topo da tela
        document.body.appendChild(errorElement);
        
        // Remover após 5 segundos
        setTimeout(() => {
            errorElement.remove();
        }, 5000);
    }

    // Função para atualizar a lista de páginas
    function updatePageList(pages) {
        const select = document.getElementById('page-select');
        select.innerHTML = '<option value="" disabled selected>Nenhuma página selecionada</option>';
        
        if (!pages || pages.length === 0) {
            showError('Nenhuma página encontrada no projeto');
            return;
        }
        
        pages.forEach(page => {
            const option = document.createElement('option');
            option.value = page.id;
            option.textContent = page.name;
            select.appendChild(option);
        });
    }

    // Função para mostrar status do changelog
    function updateChangelogStatus(hasChangelog, entryCount = 0) {
        const statusDiv = document.getElementById('changelog-status');
        const noChangelogDiv = document.getElementById('no-changelog');
        
        if (hasChangelog) {
            document.getElementById('entry-count').textContent = entryCount;
            statusDiv.style.display = 'block';
            noChangelogDiv.style.display = 'none';
        } else {
            statusDiv.style.display = 'none';
            noChangelogDiv.style.display = 'block';
        }
    }

    // Funções de navegação
    function navigateToPage(pageId) {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById(pageId).classList.add('active');
    }

    function navigateToChangelog() {
        parent.postMessage({ pluginMessage: { type: 'navigate-to-changelog' } }, '*');
    }

    function navigateToChangelogForm(mode) {
        // Definir o modo do formulário
        pluginState.formMode = mode;
        
        // Atualizar o título e o botão de acordo com o modo
        if (mode === 'create') {
            document.getElementById('form-title').textContent = 'Criar novo Changelog';
            document.getElementById('submitBtn').textContent = 'Criar Changelog';
        } else {
            document.getElementById('form-title').textContent = 'Adicionar nova alteração';
            document.getElementById('submitBtn').textContent = 'Adicionar Alteração';
        }
        
        // Limpar o formulário
        document.getElementById('changelogForm').reset();
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('fileName').textContent = '';
        document.getElementById('fileInputContainer').style.display = 'block';
        document.getElementById('removeImageBtn').style.display = 'none';
        
        // Limpar mensagens
        document.getElementById('successMessage').style.display = 'none';
        document.getElementById('errorMessage').style.display = 'none';
        
        // Limpar mensagens de erro anteriores
        document.querySelectorAll('.validation-error').forEach(el => el.remove());
        
        // Navegar para a página do formulário
        navigateToPage('changelog-form-page');
    }

    // Função para mostrar estado de carregamento
    function showLoading() {
        // Mostrar indicador de carregamento
        const select = document.getElementById('page-select');
        select.disabled = true;
        select.parentElement.classList.add('loading');
        
        // Ocultar status anterior
        document.getElementById('changelog-status').style.display = 'none';
        document.getElementById('no-changelog').style.display = 'none';
        
        // Adicionar spinner
        const spinner = document.createElement('div');
        spinner.id = 'loading-spinner';
        spinner.className = 'spinner';
        document.getElementById('home-page').appendChild(spinner);
    }
    
    // Função para esconder estado de carregamento
    function hideLoading() {
        // Reativar o select
        const select = document.getElementById('page-select');
        select.disabled = false;
        select.parentElement.classList.remove('loading');
        
        // Remover spinner se existir
        const spinner = document.getElementById('loading-spinner');
        if (spinner) spinner.remove();
    }

    // Event listeners
    document.getElementById('page-select').addEventListener('change', (e) => {
        const pageId = e.target.value;
        if (!pageId) return;
        
        pluginState.selectedPage = pageId;
        console.log(`Página selecionada: ${pageId}`);
        
        // Mostrar estado de carregamento
        showLoading();
        
        // Enviar mensagem para verificar o changelog
        parent.postMessage({ pluginMessage: { type: 'check-changelog', pageId } }, '*');
    });

    // Função para processar sucesso da operação
    function onFormSuccess() {
        // Exibir mensagem de sucesso
        document.getElementById('successMessage').style.display = 'block';
        
        // Voltar para a página inicial após 1,5 segundos
        setTimeout(() => {
            document.getElementById('successMessage').style.display = 'none';
            navigateToPage('home-page');
            
            // Limpar formulário
            document.getElementById('changelogForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('fileName').textContent = '';
            document.getElementById('fileInputContainer').style.display = 'block';
            document.getElementById('removeImageBtn').style.display = 'none';
        }, 1500);
    }

    // Função para atualizar o estado do plugin
    function updatePluginState(hasChangelog, entryCount, currentPageId) {
        console.log(`Atualizando estado do plugin: hasChangelog=${hasChangelog}, entryCount=${entryCount}, pageId=${currentPageId}`);
        
        // Atualizar o estado global
        pluginState.hasChangelog = hasChangelog;
        pluginState.entryCount = entryCount;
        
        // Se temos um ID de página, atualizar a seleção do dropdown
        if (currentPageId) {
            // Verificar se o ID da página já está selecionado
            if (document.getElementById('page-select').value !== currentPageId) {
                document.getElementById('page-select').value = currentPageId;
            }
        }
        
        // Atualizar a interface com o estado atual
        updateChangelogStatus(hasChangelog, entryCount);
    }

    // Receber mensagens do plugin - principal handler
    window.onmessage = function(event) {
        const message = event.data.pluginMessage;
        if (!message) return;
        
        console.log("Mensagem recebida do plugin:", message.type);
        
        // Esconder estado de carregamento
        hideLoading();
        
        // Mensagens relacionadas à navegação
        if (message.type === 'update-pages') {
            console.log('Atualizando lista de páginas:', message.pages.length);
            updatePageList(message.pages);
        } 
        else if (message.type === 'changelog-status') {
            console.log('Atualizando status do changelog:', message.hasChangelog);
            updatePluginState(message.hasChangelog, message.entryCount || 0, message.currentPageId);
        } 
        else if (message.type === 'navigate-to-home') {
            console.log('Redirecionando para a página inicial');
            
            // Atualizar estado se houver informações sobre a página atual
            if (message.hasChangelog !== undefined && message.entryCount !== undefined) {
                console.log('Atualizando estado antes de redirecionar');
                updatePluginState(message.hasChangelog, message.entryCount, message.currentPageId);
            }
            
            // Navegar para a página inicial
            navigateToPage('home-page');
        }
        else if (message.type === 'error') {
            console.error('Erro recebido do plugin:', message.message);
            
            // Exibir erro na página ativa atual
            if (document.getElementById('changelog-form-page').classList.contains('active')) {
                document.getElementById('errorMessage').textContent = message.message || 'Ocorreu um erro desconhecido';
                document.getElementById('errorMessage').style.display = 'block';
            } 
            else {
                // Se não estiver em uma página específica, mostrar como erro flutuante
                showError(message.message || 'Ocorreu um erro desconhecido');
            }
        }
        
        // Processar resposta com informações do usuário
        else if (message.type === 'user-info') {
            console.log('Recebidas informações do usuário');
            if (message.photoUrl) {
                // Se temos uma URL de foto, tente processá-la
                parent.postMessage({ 
                    pluginMessage: { 
                        type: 'process-user-image', 
                        photoUrl: message.photoUrl 
                    } 
                }, '*');
            } else if (window.currentImageCallback) {
                // Se não temos URL, responda o callback com null
                window.currentImageCallback(null);
                delete window.currentImageCallback;
            }
        }
        
        // Lidar com bytes da imagem que o plugin processou
        else if (message.type === 'user-image-bytes') {
            try {
                console.log('Recebidos bytes de imagem do plugin, convertendo para base64');
                // Converter array de bytes para Uint8Array
                const imageBytes = new Uint8Array(message.imageBytes);
                
                // Criar um Blob a partir dos bytes
                const blob = new Blob([imageBytes], { type: `image/${message.format.toLowerCase()}` });
                
                // Converter Blob para base64
                const reader = new FileReader();
                reader.onload = function() {
                    const base64data = reader.result;
                    console.log('Bytes de imagem convertidos para base64 com sucesso');
                    
                    // Se isso estiver em um processamento pendente, continuar
                    if (window.currentImageCallback) {
                        window.currentImageCallback(base64data);
                        delete window.currentImageCallback;
                    }
                };
                
                reader.onerror = function(error) {
                    console.error('Erro ao converter bytes para base64:', error);
                    if (window.currentImageCallback) {
                        window.currentImageCallback(null);
                        delete window.currentImageCallback;
                    }
                };
                
                reader.readAsDataURL(blob);
            } catch (error) {
                console.error('Erro ao processar bytes da imagem:', error);
                if (window.currentImageCallback) {
                    window.currentImageCallback(null);
                    delete window.currentImageCallback;
                }
            }
        }
        
        // Responder diretamente com imagem processada
        else if (message.type === 'user-image-processed' && window.currentImageCallback) {
            console.log('Recebida imagem já processada do plugin');
            window.currentImageCallback(message.imageData);
            delete window.currentImageCallback;
        }
        
        // Erro no processamento da imagem
        else if (message.type === 'user-image-error' && window.currentImageCallback) {
            console.error('Erro no processamento da imagem:', message.error);
            window.currentImageCallback(null);
            delete window.currentImageCallback;
        }
        
        // Restaurar o botão para o estado normal
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) {
            submitBtn.textContent = pluginState.formMode === 'create' ? 'Criar Changelog' : 'Adicionar Entrada';
            submitBtn.disabled = false;
        }
        
        if (message.type === 'success') {
            // Atualizar estado se houver informações sobre a página atual
            if (message.hasChangelog !== undefined && message.entryCount !== undefined) {
                console.log('Atualizando estado após operação bem-sucedida');
                updatePluginState(message.hasChangelog, message.entryCount, message.currentPageId);
            }
            
            // Verificar se estamos na página do formulário
            if (document.getElementById('changelog-form-page').classList.contains('active')) {
                onFormSuccess();
            }
        }
    };

    // Solicitar lista de páginas ao carregar
    console.log("Solicitando lista de páginas...");
    setTimeout(() => {
        parent.postMessage({ pluginMessage: { type: 'get-pages' } }, '*');
    }, 500);

    // ======== BEGIN: UPLOAD DE IMAGENS (Abordagem Botão Dedicado) ========
    // Garantir que esta inicialização ocorra apenas uma vez
    if (!window.uiImageUploadInitialized) {
        window.uiImageUploadInitialized = true; // Marcar como inicializado
        
        console.log('Inicializando listeners de upload de imagem com Botão (única vez)');

        const fileInputContainer = document.getElementById('fileInputContainer');
        const imageFileInput = document.getElementById('imageFile');
        const removeImageBtn = document.getElementById('removeImageBtn');
        const uploadImageBtn = document.getElementById('uploadImageBtn'); // Novo botão
        
        // Limpar listeners antigos (precaução)
        if (fileInputContainer) fileInputContainer.onclick = null; // Remover listener do container
        if (uploadImageBtn) uploadImageBtn.onclick = null;
        if (imageFileInput) imageFileInput.onchange = null;
        if (removeImageBtn) removeImageBtn.onclick = null;
        
        // Evento de clique no NOVO BOTÃO de upload
        if (uploadImageBtn && imageFileInput) {
            uploadImageBtn.onclick = function(event) {
                console.log('Botão Enviar Imagem clicado');
                if (event) {
                    event.preventDefault();
                    event.stopPropagation(); // Importante para não acionar outros cliques
                }
                imageFileInput.click(); // Aciona o input escondido
            };
        } else {
            console.error('Botão de upload ou input de arquivo não encontrado.');
        }
        
        // Evento change do input (continua igual)
        if (imageFileInput) {
            imageFileInput.onchange = function() {
                console.log('Input de arquivo: evento change (button approach)');
                const file = this.files[0];
                if (file) {
                    console.log('Arquivo selecionado:', file.name);
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('imagePreview');
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                        document.getElementById('fileName').textContent = file.name;
                        
                        if (fileInputContainer) fileInputContainer.style.display = 'none';
                        if (removeImageBtn) removeImageBtn.style.display = 'inline-block';
                    };
                    reader.readAsDataURL(file);
                }
            };
        }
        
        // Evento click do botão remover (continua igual)
        if (removeImageBtn && imageFileInput && fileInputContainer) {
            removeImageBtn.onclick = function() {
                console.log('Botão remover: clicado (button approach)');
                imageFileInput.value = ''; // Limpa o input
                document.getElementById('imagePreview').src = '';
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('fileName').textContent = '';
                
                this.style.display = 'none';
                fileInputContainer.style.display = 'block';
            };
        }
    }
    // ======== END: UPLOAD DE IMAGENS (Abordagem Botão Dedicado) ========

    // Função para mostrar erro de validação
    function showValidationError(inputElement, message) {
      const errorElement = document.createElement('div');
      errorElement.className = 'validation-error';
      errorElement.textContent = message;
      errorElement.style.color = '#e11d48';
      errorElement.style.fontSize = '12px';
      errorElement.style.marginTop = '4px';
      errorElement.style.marginBottom = '8px';
      
      // Inserir após o elemento
      inputElement.parentNode.insertBefore(errorElement, inputElement.nextSibling);
      
      // Destacar o campo com erro
      inputElement.style.borderColor = '#e11d48';
      
      // Remover destaque quando o usuário começar a digitar novamente
      inputElement.addEventListener('input', function() {
        inputElement.style.borderColor = '';
        const error = inputElement.nextSibling;
        if (error && error.className === 'validation-error') {
          error.remove();
        }
      }, { once: true });
    }

    // Função para validar URL
    function isValidUrl(string) {
      try {
        if (!string || string.trim() === '') return true; // URL vazia é considerada válida (opcional)
        
        // Se não começar com http:// ou https://, é inválida
        if (!string.startsWith('http://') && !string.startsWith('https://')) {
          return false;
        }
        
        const url = new URL(string);
        // Verificar se tem protocolo válido
        return url.protocol === "http:" || url.protocol === "https:";
      } catch (_) {
        return false;
      }
    }

    // Implementação da função processUserPhoto
    function processUserPhoto(callback) {
      // Inicialmente enviar para o plugin pedindo informações do usuário
      parent.postMessage({ pluginMessage: { type: 'get-user-info' } }, '*');
      
      // Variável para armazenar o callback e usar quando a resposta chegar
      window.currentImageCallback = callback;
      
      // Se depois de 3 segundos não tivermos resposta, resolva com null
      setTimeout(() => {
        if (window.currentImageCallback) {
          console.log('Tempo esgotado ao esperar pela foto do usuário, continuando sem ela');
          const cb = window.currentImageCallback;
          delete window.currentImageCallback;
          cb(null);
        }
      }, 3000);
    }

    // Formulário de envio unificado
    document.getElementById('changelogForm').addEventListener('submit', async function(event) {
      event.preventDefault();
      const form = this;
      
      // Limpar mensagens de erro anteriores
      document.querySelectorAll('.validation-error').forEach(el => el.remove());
      
      // Pegar valores do formulário
      const title = form.title.value;
      const description = form.description.value;
      const changeType = form.changeType.value;
      const linkUrl = form.linkUrl.value;
      const linkLabel = form.linkLabel.value;
      const imagePreview = document.getElementById('imagePreview');
      const imageFile = document.getElementById('imageFile').files[0];
      
      // Validações básicas
      let hasError = false;
      
      if (!title.trim()) {
        showValidationError(form.title, 'Título é obrigatório');
        hasError = true;
      }
      
      if (!description.trim()) {
        showValidationError(form.description, 'Descrição é obrigatória');
        hasError = true;
      }
      
      if (!changeType) {
        showValidationError(form.changeType, 'Selecione o tipo de alteração');
        hasError = true;
      }
      
      // Validar URL se foi preenchida
      if (linkUrl.trim() && !isValidUrl(linkUrl)) {
        showValidationError(form.linkUrl, 'URL inválida. O link deve começar com http:// ou https://');
        hasError = true;
      }
      
      // Validar que se tem URL precisa ter label e vice-versa
      if (linkUrl.trim() && !linkLabel.trim()) {
        showValidationError(form.linkLabel, 'Preencha o texto do link');
        hasError = true;
      }
      
      if (linkLabel.trim() && !linkUrl.trim()) {
        showValidationError(form.linkUrl, 'Preencha a URL do link');
        hasError = true;
      }
      
      if (hasError) {
        return;
      }
      
      // Limpar mensagem de erro geral
      document.getElementById('errorMessage').textContent = '';
      document.getElementById('errorMessage').style.display = 'none';

      // Desabilitar botão para prevenir cliques múltiplos
      const submitBtn = document.getElementById('submitBtn');
      const originalBtnText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Enviando...';

      // Dados iniciais do formulário
      const data = {
        title: title,
        description: description,
        changeType: changeType,
        linkUrl: linkUrl,
        linkLabel: linkLabel,
        imageData: imagePreview.style.display !== 'none' ? imagePreview.src : null,
        userPhotoData: null // Será preenchido pela função processUserPhoto
      };

      try {
        // Processar a foto do usuário para base64
        await new Promise((resolve) => {
          processUserPhoto(function(userPhotoBase64) {
            data.userPhotoData = userPhotoBase64;
            resolve();
          });
        });
        
        // Determinar o tipo de mensagem com base no modo do formulário
        const messageType = pluginState.formMode === 'create' 
          ? 'create-changelog' 
          : 'add-changelog-entry';
          
        console.log(`Enviando dados do formulário com o tipo: ${messageType}`);
        
        // Enviar dados para o plugin
        parent.postMessage({ 
          pluginMessage: { 
            type: messageType, 
            data: data 
          } 
        }, '*');
      } catch (error) {
        console.error('Erro ao processar dados:', error);
        document.getElementById('errorMessage').textContent = 'Erro ao processar dados: ' + error.message;
        document.getElementById('errorMessage').style.display = 'block';
        
        // Restaurar botão
        submitBtn.disabled = false;
        submitBtn.textContent = originalBtnText;
      }
    });
  </script>
</body>
</html> 